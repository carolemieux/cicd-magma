# tosem-scripts

Scripts used in data processing and for presenting data in the paper. 

## Data Processing Scripts

Directory structure of `processing-scripts` is as follows. Refer to processing instructions
below for details and usage examples. Each script also contains usage instructions.

```
processing-scripts
- adjust_results_for_poll_error.py: to remove POLL seconds from bug reaching/triggering times
- create_results_with_instrumentation_time.py: to add instrumentation time to the Magma results json
- extract_build_times.sh: to extract the instrumentation time from raw Magma logs
```

### Processing Instructions

This contains detailed instructions for creating processed data as in our paper. Refer to 
the README.md for `tosem-results` for a description of what the processed data represent.

Prereqs: You will need python3 with matplotlib, pandas, numpy, and scipy installed.

### Processing Instructions: Creating main bug reaching/triggering results

I.e., creating the bug reaching/triggering numbers and survival times. 
(`main-results` and `sensitivity-results` in `tosem-results`)

We assume you have raw data for each fuzzer separately. So, the directory `X`
contains the `ar`, `log`, and `poc` directories (as generated by Magma)
containing only results for `fuzzer`.

#### 1: Extracting reach/trigger times

First you must extract the first time bugs were reached/triggered by the fuzzer.
For this we reuse the `exp2json` scripts provided by Magma. Assuming the directory
`X` contains only the results for `fuzzer`, and `my_main_results` is the directory
where the results should be stored, the command is:

```
$ MAGMA_ROOT/tools/benchd/exp2json.py $X ${my_main_results}/${fuzzer}.json
```

If you have downloaded the original raw data for the paper [TODO: add link], 
decompressing them should result in a directory `main-experiment-raw-data`, with
subdirectories for each fuzzer. (i.e., `afl`, `aflgo`, `tunefuzz`). A helper 
script to run this for each fuzzer and populate `my_main_results` with a `fuzzer.json`
for each fuzzer:

```
for fuzzerfolder in main-experiment-raw-data/*; do 
    fuzzer=`basename $fuzzerfolder` 
    $MAGMA_ROOT/tools/benchd/exp2json.py $fuzzerfolder ${my_main_results}/${fuzzer}.json 
done
```

#### 1.5: Adjusting for poll error

If you are running this on data generated before [Magma off-by-poll error](https://github.com/HexHive/magma/pull/179/conflicts) is fixed,
use the following script to adjust for the error. This should be run on the results from our experiments to
replicate the numbers in the paper. If you do not care about the poll error, you can skip this step. 

```
$ python3 $MAGMA_ROOT/tosem-scripts/processing-scripts/adjust_results_for_poll_error.py -p 5 ${fuzzer}.json
```

A bash loop to run on results generated in the last step:
```
for fuzzerjson in main-experiment-raw-data/*; do 
    python3 $MAGMA_ROOT/tosem-scripts/processing-scripts/adjust_results_for_poll_error.py -p 5 $fuzzerjson
done
```

Note `adjust_results_for_poll_error.py` will edit the json in-place; it will complain if it looks like the
results have already been adjusted

#### 2: Extracting build/instrumentation time

Now we will extract the build + instrumentation time. Again, assuming the directory
`X` contains only the results for `fuzzer`, and `my_main_results` is the directory
where the results should be stored, the command is:

```
$ ./extract_build_times.sh $X > ${my_main_results}/${fuzzer}-inst.csv
```

And here is another bash loop for looking at our raw data:
```
for fuzzerfolder in main-experiment-raw-data/*; do 
    fuzzer=`basename $fuzzerfolder` 
    $MAGMA_ROOT/tosem-scripts/processing-scripts/extract_build_times.sh $fuzzerfolder > ${my_main_results}/${fuzzer}-inst.csv 
done
```

Note that if the build/instrumentation time was cached by Magma (i.e., found in the docker cache)
the script will report `CACHED` in the csv and report a warning. This is because the build time
cannot be extracted. Try clearing the docker file and acquiring a new build log to replace this
with a real number. 

#### 3: Creating bug reaching/instrumentation times with instrumentation time including

Finally we create the results including instrumentation times. Assuming `my_main_results`
contains `fuzzer.json` and `fuzzer-inst.csv`, containing the bug reaching/trigger json
and the extracted instrumentation time, the command is:

```
$ python3 create_results_with_instrumentation_time.py ${fuzzer}.json ${fuzzer}-inst.csv ${fuzzer}-inst.json
```

And in loop form
```
for fuzzerfolder in main-experiment-raw-data/*; do 
    fuzzer=`basename $fuzzerfolder` 
    python3 $MAGMA_ROOT/tosem-scripts/processing-scripts/create_results_with_instrumentation_time.py \
    ${fuzzer}.json ${fuzzer}-inst.csv ${fuzzer}-inst.json
done
```

Congratulations! You have now reproduced something like `tosem-results/main-results` 
or `tosem-results/sensitivity-results`!

### Processing Instructions: Creating the auxiliary results


#### Coverage

This assumes that `COVERAGE_DIR` contains all the `[...]_total_coverage.txt` and `[...]_target_file_coverage.txt` you
are interested in analyzing.

###### Getting the total_cov/target_file_cov files
If you are using our packaged results from zenodo, these can be found in the **TODO** directory.

If you are using our `llvm_cov` "fuzzer" to calculate new coverage data, and its results directory is `NEW_COV_RES`,
you can find these files at the following path:
```
$NEW_COV_RES/ar/llvm_cov/[benchmark_name]/[driver_name]/[iteration_name]/coverage
```
You may have to untar the `ball.tar` found at `$NEW_COV_RES/ar/llvm_cov/[benchmark_name]/[driver_name]/[iteration_name]`
to get these files. 

##### Extracting Coverage Data

To get total coverage processed results:
```
$ ./extract_coverage_to_csv.sh $COVERAGE_DIR > processed_coverage.csv
```
To get target coverage processed results:
```
$ ./extract_target_coverage_to_csv.sh $COVERAGE_DIR > processed_target_coverage.csv
```

#### Execs and runtime

We assume you have raw data for each fuzzer separately. So, the directory `fuzzer-results`
contains the `ar`, `log`, and `poc` directories (as generated by Magma)
containing only results for `fuzzer`.

Run
```
$ ./extract_execs_and_runtime.py ${fuzzer-results} fuzzer_execs_and_fuzz_time.csv
```


#### Number of seeds

We don't report this number in the paper in the end, but you can create `num_seeds.csv` as follows,
if you are in  the `$MAGMA_ROOT/seed` directory:

```
$ for bench_dir in */*; do harness=$(basename $bench_dir); seeds=$(ls -1 $bench_dir | wc -l); echo "$harness,$seeds"; done
```

## Data Presentation Scripts

Directory structure of `presentation-scripts`:

